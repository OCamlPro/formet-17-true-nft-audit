
\chapter{Contract Data}

\minitoc

\section{Overview}


\issueMajor{No way to get funds back}{
    Tokens sent to the contract are locked forever.
    %
    They are sent when IndexBasis are destroyed and when
    contracts are deployed.
}


\section{Contract Inheritance}


\noindent\begin{tabular}{|l|p{5cm}|}\hline
IData & \\\hline
IndexResolver & \\\hline
\end{tabular}


\section{Static Variable Definitions}


\ifsoltables
\noindent\begin{tabular}{|l|l|p{5cm}|}\hline
uint256 & \_{}id &  \\\hline
\end{tabular}
\fi


\begin{lstlisting}[firstnumber=18]
    uint256 static _id;
\end{lstlisting}

\section{Variable Definitions}


\ifsoltables
\noindent\begin{tabular}{|l|l|p{5cm}|}\hline
address & \_{}addrRoot &  \\\hline
 & & used in @7.Data.transferOwnership\\\hline
 & & used in @7.Data.getInfo\\\hline
 & & used in @7.Data.deployIndex\\\hline
 & & used in @7.Data.deployIndex\\\hline
 & & used in @7.Data.deployIndex\\\hline
 & & assigned in @7.Data.:constructor\\\hline
 & & used in @7.Data.:constructor\\\hline
address & \_{}addrOwner &  \\\hline
 & & assigned in @7.Data.transferOwnership\\\hline
 & & used in @7.Data.transferOwnership\\\hline
 & & used in @7.Data.transferOwnership\\\hline
 & & used in @7.Data.transferOwnership\\\hline
 & & used in @7.Data.transferOwnership\\\hline
 & & used in @7.Data.getOwner\\\hline
 & & used in @7.Data.getInfo\\\hline
 & & assigned in @7.Data.:constructor\\\hline
 & & used in @7.Data.:constructor\\\hline
address & \_{}addrAuthor &  \\\hline
 & & assigned in @7.Data.:constructor\\\hline
 & & used in @7.Data.:constructor\\\hline
\end{tabular}
\fi


\begin{lstlisting}[firstnumber=14]
    address _addrRoot;
\end{lstlisting}

\begin{lstlisting}[firstnumber=15]
    address _addrOwner;
\end{lstlisting}

\begin{lstlisting}[firstnumber=16]
    address _addrAuthor;
\end{lstlisting}

\section{Constructor Definitions}


\subsection{Constructor}

\issueMinor{Constants}{
    Value "101" should be defined as a constant
}

\issueMajor{addrOwner may be null}{
    The owner of the contract may be null.
}

\begin{lstlisting}[firstnumber=20]
    constructor(address addrOwner, TvmCell codeIndex) public {
        optional(TvmCell) optSalt = tvm.codeSalt(tvm.code());
        require(optSalt.hasValue(), 101);
        (address addrRoot) = optSalt.get().toSlice().decode(address);
        require(msg.sender == addrRoot);
        require(msg.value >= Constants.MIN_FOR_DEPLOY);
        tvm.accept();
        _addrRoot = addrRoot;
        _addrOwner = addrOwner;
        _addrAuthor = addrOwner;
        _codeIndex = codeIndex;

        deployIndex(addrOwner);
    }
\end{lstlisting}

\section{Public Method Definitions}


\subsection{Function getInfo}

\begin{lstlisting}[firstnumber=59]
    function getInfo() public view override returns (
        address addrRoot,
        address addrOwner,
        address addrData
    ) {
        addrRoot = _addrRoot;
        addrOwner = _addrOwner;
        addrData = address(this);
    }
\end{lstlisting}

\subsection{Function getOwner}

\begin{lstlisting}[firstnumber=69]
    function getOwner() public view override returns(address addrOwner) {
        addrOwner = _addrOwner;
    }
\end{lstlisting}

\subsection{Function transferOwnership}

\issueCritical{Methods called without value TODO: CHECK}{
    IIndex(\_).destruct() are called without sending funds.
}

\issueMajor{New owner may be null}{
    The new owner of the contract may be null.
}

\issueMinor{New owner may be equal to the old one}{
    The new owner of the contract may be equal to the old one, hence
    destructing and rebuilding identical contracts.
}

\begin{lstlisting}[firstnumber=35]
    function transferOwnership(address addrTo) public override {
        require(msg.sender == _addrOwner);
        require(msg.value >= Constants.MIN_FOR_DEPLOY);

        address oldIndexOwner = resolveIndex(_addrRoot, address(this), _addrOwner);
        IIndex(oldIndexOwner).destruct();
        address oldIndexOwnerRoot = resolveIndex(address(0), address(this), _addrOwner);
        IIndex(oldIndexOwnerRoot).destruct();

        _addrOwner = addrTo;

        deployIndex(addrTo);
    }
\end{lstlisting}

\section{Internal Method Definitions}


\subsection{Function deployIndex}

\issueMinor{Constants}{
    Value "0.4 ton" should be defined as a constant
}

\begin{lstlisting}[firstnumber=49]
    function deployIndex(address owner) private {
        TvmCell codeIndexOwner = _buildIndexCode(_addrRoot, owner);
        TvmCell stateIndexOwner = _buildIndexState(codeIndexOwner, address(this));
        new Index{stateInit: stateIndexOwner, value: 0.4 ton}(_addrRoot);

        TvmCell codeIndexOwnerRoot = _buildIndexCode(address(0), owner);
        TvmCell stateIndexOwnerRoot = _buildIndexState(codeIndexOwnerRoot, address(this));
        new Index{stateInit: stateIndexOwnerRoot, value: 0.4 ton}(_addrRoot);
    }
\end{lstlisting}
